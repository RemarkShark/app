var Lawnchair=function(a,b){if(!(this instanceof Lawnchair))return new Lawnchair(a,b);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(!(arguments.length<=2))throw"Incorrect # of ctor args!";b="function"==typeof arguments[0]?arguments[0]:arguments[1],a="function"==typeof arguments[0]?{}:arguments[0]||{},this.record=a.record||"record",this.name=a.name||"records";var c;if(a.adapter){"string"==typeof a.adapter&&(a.adapter=[a.adapter]);for(var d=0,e=a.adapter.length;e>d;d++){for(var f=Lawnchair.adapters.length-1;f>=0&&(Lawnchair.adapters[f].adapter!==a.adapter[d]||!(c=Lawnchair.adapters[f].valid()?Lawnchair.adapters[f]:void 0));f--);if(c)break}}else for(var f=0,g=Lawnchair.adapters.length;g>f&&!(c=Lawnchair.adapters[f].valid()?Lawnchair.adapters[f]:void 0);f++);if(!c)throw"No valid adapter.";for(var d in c)this[d]=c[d];for(var f=0,g=Lawnchair.plugins.length;g>f;f++)Lawnchair.plugins[f].call(this);this.init(a,b)};Lawnchair.adapters=[],Lawnchair.adapter=function(a,b){b.adapter=a;var c="adapter valid init keys save batch get exists all remove nuke".split(" "),d=this.prototype.indexOf;for(var e in b)if(-1===d(c,e))throw"Invalid adapter! Nonstandard method: "+e;Lawnchair.adapters.splice(0,0,b)},Lawnchair.plugins=[],Lawnchair.plugin=function(a){for(var b in a)"init"===b?Lawnchair.plugins.push(a[b]):this.prototype[b]=a[b]},Lawnchair.prototype={isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},indexOf:function(a,b,c,d){if(a.indexOf)return a.indexOf(b);for(c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},lambda:function(a){return this.fn(this.record,a)},fn:function(a,b){return"string"==typeof b?new Function(a,b):b},uuid:function(){var a=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},each:function(a){var b=this.lambda(a);if(this.__results)for(var c=0,d=this.__results.length;d>c;c++)b.call(this,this.__results[c],c);else this.all(function(a){for(var c=0,d=a.length;d>c;c++)b.call(this,a[c],c)});return this}},"undefined"!=typeof module&&module.exports&&(module.exports=Lawnchair),Lawnchair.adapter("indexed-db",function(){function a(a,b){console.error("error in indexed-db adapter!",a,b)}var b=3,c=function(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB},d=function(){return window.IDBTransaction||window.webkitIDBTransaction||window.mozIDBTransaction||window.oIDBTransaction||window.msIDBTransaction},e=function(){return window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange||window.oIDBKeyRange||window.msIDBKeyRange},f=function(){return window.IDBDatabaseException||window.webkitIDBDatabaseException||window.mozIDBDatabaseException||window.oIDBDatabaseException||window.msIDBDatabaseException},g=function(){return!!window.indexedDB},h=d()&&"READ_WRITE"in d()?d().READ_WRITE:"readwrite";return{valid:function(){return!!c()},init:function(d,e){this.idb=c(),this.waiting=[],this.useAutoIncrement=g();var h=this.idb.open(this.name,b),i=this,j=i.fn(i.name,e);if(j&&"function"!=typeof j)throw"callback not valid";var k=function(){return h.onupgradeneeded=h.onsuccess=h.error=null,j?j.call(i,i):void 0},l=function(){try{i.db.deleteObjectStore("teststore")}catch(a){}try{i.db.deleteObjectStore(i.record)}catch(b){}var c={};i.useAutoIncrement&&(c.autoIncrement=!0),i.db.createObjectStore(i.record,c),i.store=!0};h.onupgradeneeded=function(a){i.db=h.result,i.transaction=h.transaction,l(a.oldVersion,a.newVersion)},h.onsuccess=function(c){if(i.db=c.target.result,i.db.version!=""+b){var d=i.db.version,e=i.db.setVersion(""+b);e.onsuccess=function(){var a=e.result;e.onsuccess=e.onerror=null,l(d,b),a.oncomplete=function(){for(var a=0;a<i.waiting.length;a++)i.waiting[a].call(i);i.waiting=[],k()}},e.onerror=function(b){e.onsuccess=e.onerror=null,console.error("Failed to create objectstore "+b),a(b)}}else{i.store=!0;for(var f=0;f<i.waiting.length;f++)i.waiting[f].call(i);i.waiting=[],k()}},h.onerror=function(){return h.errorCode===f().VERSION_ERR?(i.idb.deleteDatabase(i.name),i.init(d,e)):void console.error("Failed to open database")}},save:function(b,c){var d=this;if(!this.store)return void this.waiting.push(function(){this.save(b,c)});for(var e=(this.isArray(b)?b:[b]).map(function(a){return a.key||(a.key=d.uuid()),a}),f=function(){c&&d.lambda(c).call(d,d.isArray(b)?e:e[0])},g=this.db.transaction(this.record,h),i=g.objectStore(this.record),j=0;j<e.length;j++){var k=e[j];i.put(k,k.key)}return i.transaction.oncomplete=f,i.transaction.onabort=a,this},batch:function(a,b){return this.save(a,b)},get:function(b,c){if(!this.store)return void this.waiting.push(function(){this.get(b,c)});var d=this,e=function(a){var e=a.target.result;c&&(e&&(e.key=b),d.lambda(c).call(d,e))};if(this.isArray(b))for(var f=[],g=b.length,h=b,i=function(a){d.get(h[a],function(b){f[a]=b,--g>0||c&&d.lambda(c).call(d,f)})},j=0,k=h.length;k>j;j++)i(j);else{var l=this.db.transaction(this.record).objectStore(this.record).get(b);l.onsuccess=function(a){l.onsuccess=l.onerror=null,e(a)},l.onerror=function(b){l.onsuccess=l.onerror=null,a(b)}}return this},exists:function(b,c){if(!this.store)return void this.waiting.push(function(){this.exists(b,c)});var d=this,f=this.db.transaction(d.record).objectStore(this.record).openCursor(e().only(b));return f.onsuccess=function(a){f.onsuccess=f.onerror=null;var b;d.lambda(c).call(d,null!==a.target.result&&a.target.result!==b)},f.onerror=function(b){f.onsuccess=f.onerror=null,a(b)},this},all:function(a){if(!this.store)return void this.waiting.push(function(){this.all(a)});var b=this.fn(this.name,a)||void 0,c=this,d=this.db.transaction(this.record).objectStore(this.record),e=[];return d.openCursor().onsuccess=function(a){var d=a.target.result;d?(e.push(d.value),d["continue"]()):b&&b.call(c,e)},this},keys:function(a){if(!this.store)return void this.waiting.push(function(){this.keys(a)});var b=this.fn(this.name,a)||void 0,c=this,d=this.db.transaction(this.record).objectStore(this.record),e=[];return d.openCursor().onsuccess=function(a){var d=a.target.result;d?(e.push(d.key),d["continue"]()):b&&b.call(c,e)},this},remove:function(b,c){if(!this.store)return void this.waiting.push(function(){this.remove(b,c)});var d=this,e=b;this.isArray(b)||(e=[b]);for(var f=function(){c&&d.lambda(c).call(d)},g=this.db.transaction(this.record,h).objectStore(this.record),i=b.key?b.key:b,j=0;j<e.length;j++){var i=e[j].key?e[j].key:e[j];g["delete"](i)}return g.transaction.oncomplete=f,g.transaction.onabort=a,this},nuke:function(b){if(!this.store)return void this.waiting.push(function(){this.nuke(b)});var c=this,d=b?function(){c.lambda(b).call(c)}:function(){};try{var e=this.db.transaction(this.record,h).objectStore(this.record);e.clear(),e.transaction.oncomplete=d,e.transaction.onabort=a}catch(f){"NotFoundError"==f.name?d():a(f)}return this}}}()),Lawnchair.plugin(function(){var a=function(a,b){for(var c=a.split("?").filter(function(a){return""!=a}),d="",e=0,f=c.length;f>e;e++)d+=c[e]+b[e];return d},b=function(a){return function(b,c){return b[a]<c[a]?-1:b[a]>c[a]?1:0}};return{where:function(){var b=[].slice.call(arguments),c=b.shift(),d=b[b.length-1],e=c.match(/\?/g),f=e&&e.length>0?a(c,b.slice(0,e.length)):c,g=new Function(this.record,"return !!("+f+")"),h=[];return this.all(function(a){for(var c=0,e=a.length;e>c;c++)g.call(a[c],a[c])&&h.push(a[c]);this.__results=h,1===b.length&&this.fn(this.name,d).call(this,this.__results)}),this},asc:function(a,c){return this.fn(this.name,c).call(this,this.__results.sort(b(a))),this},desc:function(a,c){return this.fn(this.name,c).call(this,this.__results.sort(b(a)).reverse()),this}}}());