"use strict";var app=angular.module("annotatewithmeApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angular-loading-bar"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/sessions/:sessionId",{templateUrl:"views/annotate.html",controller:"AnnotationCtrl",resolve:{session:["$q","$route","Session",function(a,b,c){var d=a.defer(),e=b.current.params.sessionId,f=sessionStorage.getItem(e);return f?d.resolve(JSON.parse(f)):c.fetch(e).then(function(a){$("head").append('<link rel="prefetch" href="'+a.data.img_src+'">'),sessionStorage.setItem(a.data.uniq_hash,JSON.stringify(a.data)),d.resolve(a.data)}),d.promise}]}}).otherwise({redirectTo:"/"})}]),app.run(["Syncmanager",function(){}]),angular.module("annotatewithmeApp").controller("MainCtrl",["$scope","$location","$timeout","Session",function(a,b,c,d){var e=function(a){$("head").append('<link rel="prefetch" href="'+a.img_src+'">'),sessionStorage.setItem(a.uniq_hash,JSON.stringify(a)),c(function(){b.path("/sessions/"+a.uniq_hash)})};a.newSession=function(a){a&&a.trim().length>0&&d.create(a).then(function(a){e(a.data)})},a.joinSession=function(a){a&&d.fetch(a).then(function(a){e(a.data)})}}]),angular.module("annotatewithmeApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("annotatewithmeApp").controller("AnnotationCtrl",["$scope","AnnotationsService","$routeParams","$timeout",function(a,b,c){anno.destroy(),a.session=JSON.parse(sessionStorage.getItem(c.sessionId)),a.session.imgSrc=a.session.img_src,a.annotations=[];var d=function(){a.$$phase||a.$apply()},e=function(b){anno.removeAll(),a.annotations=[],d(),angular.forEach(b,function(b){var c=b.value;console.log("in get annotation",c),a.annotations.push(c),anno.addAnnotation(c)}),d()};a.addHighlight=function(a){anno.highlightAnnotation(a)},a.removeHighlight=function(){anno.highlightAnnotation()},a.$on("annotorious-ready",function(){b.getAllUndeleted(e)}),a.$on("annotations-changed",function(){b.getAllUndeleted(e)}),anno.addHandler("onAnnotationCreated",function(c){b.createAnnotation(c),a.annotations.push(c),d()}),anno.addHandler("onAnnotationRemoved",function(c){b.flagDeletedAnnotation(c.id),a.annotations.splice(a.annotations.indexOf(c),1),d()}),anno.addHandler("onAnnotationUpdated",function(c){a.annotations=a.annotations.filter(function(a){var d=$.extend(!0,d,a),e=$.extend(!0,e,c);return delete d.text,delete e.text,console.log(d,e),JSON.stringify(d)==JSON.stringify(e)?(b.updateAnnotation(a.id,c),!1):!0}),a.annotations.push(c),d()})}]),angular.module("annotatewithmeApp").directive("annotorious",["$rootScope","$timeout",function(a,b){return{restrict:"A",link:function(c,d){var e=d[0];$(e).bind("load",function(){b(function(){anno.makeAnnotatable(e),a.$broadcast("annotorious-ready")}),c.$on("$destroy",function(){anno.destroy(e.src)})})}}}]),angular.module("annotatewithmeApp").service("AnnotationsService",["Utilities","Constants","$routeParams","$rootScope",function(a,b,c,d){var e=new Lawnchair({name:b.annotations_db+c.sessionId}),f={persisted:!1,deleted:!1};this.createAnnotation=function(b){var c=a.uuid();e.save({key:c,value:$.extend(!0,b,f,{id:c})})},this.createPersistedAnnotation=function(a){e.save({key:a.id,value:$.extend(!0,a,{deleted:!1,persisted:!0})},function(){d.$broadcast("annotations-changed")})},this.getAnnotations=function(a){e.all(a)},this.getAllUndeleted=function(a){e.where("record.value.deleted == false",a)},this.getAllMarkedDelete=function(a){e.where("record.value.deleted == true",a)},this.updateAnnotation=function(a,b){e.remove(a),b.persisted=!1,e.save({key:a,value:b})},this.deleteAnnotation=function(a){e.remove(a,function(){d.$broadcast("annotations-changed")})},this.flagDeletedAnnotation=function(a){var b;b="number"==typeof a?a:'"'+a+'"',console.log(b),e.where("record.key == "+b,function(b){0!=b.length&&(b=b[0],1==b.value.persisted?(b.value.deleted=!0,e.save(b)):e.remove(a))})},this.deleteAll=function(){e.nuke()},this.getAllUnpersisted=function(a){e.where("record.value.persisted == false",a)},this.getLatestAnnotation=function(a){e.where("record.value.persisted == true",function(b){if(b.length>0){console.log("safe");var c=_.max(b,function(a){return new Date(a.value.updated_at)});a(parseInt(new Date(c.value.updated_at).getTime()/1e3))}else console.log("exception"),a(parseInt(new Date(new Date-36e5).getTime()/1e3))})}}]),angular.module("annotatewithmeApp").factory("LawnchairFactory",["$window","$log","$parse",function(a,b,c){return function(d,e){function f(a){try{return s(a)}catch(b){return null}}function g(a){return new Lawnchair({name:d},a)}function h(c,d){d=d.toString(),angular.isObject(c)&&c!==p[d]?(p[d]=p[d]||{},angular.extend(p[d],c)):p[d]=c;var e={key:d,value:t(p[d])};try{g(function(){this.save(e)})}catch(f){("QUOTA_EXCEEDED_ERR"===f.name||"NS_ERROR_DOM_QUOTA_REACHED"===f.name)&&a.localStorage.clear(),b.info("LocalStorage Exception ==> "+f.message)}}function i(a){return q.length=0,_.each(a,function(a){q.push(a)}),q}function j(a,b){a&&angular.isObject(a)&&p[b]&&p[b]!==a?angular.extend(p[b],a):p[b]=a}function k(a,b){return b&&(angular.isObject(b.value)&&angular.isObject(a)?angular.extend(a,u(b.value)):a=u(b.value),j(a,b.key)),a}function l(a){return g(function(){this.all(function(b){angular.forEach(b,function(a){j(a.value,a.key)}),a&&a(p)})}),p}function m(a){return i(l(function(b){i(b),a&&a(q)}))}function n(a){delete p[a],g(function(){this.remove(a)})}function o(a){if(p[a])return p[a];var b={};return s.assign(b,a),b}var p={},q=[],r=e&&e.isArray,s=c(e&&e.entryKey?e.entryKey:"id"),t=e&&e.transformSave?e.transformSave:angular.identity,u=e&&e.transformLoad?e.transformLoad:angular.identity,v={collection:p,save:function(a,b,c){if(a||(a=p,b=null),angular.isArray(a)?angular.forEach(a,function(a,b){h(a,f(a)||b)}):b||a&&f(a)?h(a,b||f(a)):angular.forEach(a,h),c){var d=angular.isArray(a)?_.chain(a).map(f).map(String).value():_.keys(a);_.chain(p).keys().difference(d).each(n),_.chain(p).filter(function(a){return!f(a)}).keys().each(n)}r&&i(p)},batch:function(a,b,c){var d=_.chain(a).map(function(a){return o(a)}).value();return b&&angular.isArray(b)?(b.length=0,_.each(d,function(a){b.push(a)})):b=d,g(function(){this.get(a,function(a){if(a)for(var d=a.length-1;d>=0;d--)b[d]=k(b[d],a[d]);c&&c(b)})}),b},get:function(a,b){var c=o(a);return g(function(){this.get(a,function(a){a&&(c=k(c,a)),b&&b(c)})}),c},all:r?m:l,remove:n,nuke:function(){g(function(){this.nuke()})},destroy:function(){for(var a in p)delete p[a];g(function(){this.nuke()})}};return v}}]),angular.module("annotatewithmeApp").service("Utilities",["$window",function(a){function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}var c=!1,d=function(a){c=a,$rootScope.$broadcast("event:network-connectivity",a)};return c=a.navigator.onLine,a.addEventListener("online",function(){d(!0)},!1),a.addEventListener("offline",function(){d(!1)},!1),{uuid:function(){return b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b()},isOnline:function(){return c}}}]),angular.module("annotatewithmeApp").constant("Constants",{base_url:"http://localhost:3000/api/v1/",annotations_db:"annotations"}),angular.module("annotatewithmeApp").service("Session",["$http",function(a){return{create:function(b){return a.post("/api/v1/sessions",{img_src:b})},fetch:function(b){return a.get("/api/v1/sessions/"+b)}}}]),angular.module("annotatewithmeApp").service("Syncmanager",["$timeout","AnnotationsService","Constants","$http","$routeParams","Utilities","$rootScope",function(a,b,c,d,e,f){var g=!1,h=function(){b.getLatestAnnotation(function(a){console.log(a),d.get("/api/v1/sessions/"+JSON.parse(sessionStorage.getItem(e.sessionId)).id+"/transactions?after="+a).then(function(a){var c=a.data;console.log("in peer updates",c);try{angular.forEach(c,function(a){var c=a.object;c.is_deleted?b.deleteAnnotation(c.id):b.createPersistedAnnotation(c)}),g=!1}catch(d){console.log("got exception sync in progress"),g=!1}},function(a){console.log(a),g=!1})})},i=function(){b.getAllMarkedDelete(function(a){0==a.length&&h(),console.log("in delete callback",a),angular.forEach(a,function(c){var f=c.value;d.delete("/api/v1/sessions/"+JSON.parse(sessionStorage.getItem(e.sessionId)).id+"/annotations/"+f.id).then(function(){console.log("in delete",f),b.deleteAnnotation(f.id),a.indexOf(c)==a.length-1&&h()},function(){a.indexOf(c)==a.length-1&&h()})})})},j=function(){if(console.log("polling.....",g,f.isOnline()),!g&&f.isOnline())try{g=!0,b.getAllUnpersisted(function(a){0==a.length&&i(),angular.forEach(a,function(c){var f=c.value;d.post("/api/v1/sessions/"+JSON.parse(sessionStorage.getItem(e.sessionId)).id+"/annotations",{annotation:f}).then(function(d){b.deleteAnnotation(f.id),console.log("annotation is",f),console.log("ann is",d);var e=d.data;b.createPersistedAnnotation(e),a.indexOf(c)==a.length-1&&i()},function(b){console.log(b),a.indexOf(c)==a.length-1&&i()})})})}catch(c){g=!1,console.log(c)}a(j,5e3)};return j(),{}}]);